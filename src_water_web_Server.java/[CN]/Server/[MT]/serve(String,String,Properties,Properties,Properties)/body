{
  Thread.currentThread().setPriority(Thread.MAX_PRIORITY - 1);
  if (uri.isEmpty())   uri="/";
  Page page=_pages.get(uri.substring(1));
  boolean json=uri.endsWith(".json");
  if (json && page == null)   page=_pages.get(uri.substring(1,uri.length() - 5));
  String mime=json ? MIME_JSON : MIME_HTML;
  if (page == null)   return getResource(uri);
  String sessionID=getSessionIDFromCookie(header);
  String username=_sessionManager.authenticate(sessionID);
  if (!page.authenticate(username))   return http401(uri);
  parms.putAll(files);
  String[] reqArgs=page.requiredArguments();
  if (reqArgs != null) {
    for (    String s : reqArgs) {
      if (!parms.containsKey(s) || parms.getProperty(s).isEmpty()) {
        if (json) {
          JsonObject r=new JsonObject();
          r.addProperty("Error","Not all required parameters were supplied: argument " + s + " is missing.");
          return new Response(HTTP_OK,mime,r.toString());
        }
 else {
          return new Response(HTTP_OK,mime,H2OPage.wrap(H2OPage.error("Not all required parameters were supplied to page <strong>" + uri + "</strong><br/>Argument <strong>"+ s+ "</strong> is missing.")));
        }
      }
    }
  }
  Object result;
  try {
    result=json ? page.serverJson(this,parms,sessionID) : page.serve(this,parms,sessionID);
  }
 catch (  PageError e) {
    if (json) {
      JsonObject r=new JsonObject();
      r.addProperty("Error",e.getMessage());
      result=r;
    }
 else {
      result=e.getMessage();
    }
  }
  if (result == null)   return http404(uri);
  if (result instanceof Response)   return (Response)result;
  if (result instanceof InputStream)   return new Response(NanoHTTPD.HTTP_OK,mime,(InputStream)result);
  return new Response(NanoHTTPD.HTTP_OK,mime,result.toString());
}
