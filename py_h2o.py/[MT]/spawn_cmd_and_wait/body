def spawn_cmd_and_wait(name, args, timeout=None):
    (ps, stdout, stderr) = spawn_cmd(name, args)
    rc = ps.wait(timeout)
    out = file(stdout).read()
    err = file(stderr).read()
    if (rc is None):
        ps.terminate()
        raise Exception(('%s %s timed out after %d\nstdout:\n%s\n\nstderr:\n%s' % (name, args, (timeout or 0), out, err)))
    elif (rc != 0):
        raise Exception(('%s %s failed.\nstdout:\n%s\n\nstderr:\n%s' % (name, args, out, err)))
