def build_cloud(node_count=2, base_port=54321, hosts=None, timeoutSecs=30, retryDelaySecs=1, cleanup=True, rand_shuffle=True, hadoop=False, **kwargs):
    clean_sandbox()
    if kwargs.setdefault('enable_benchmark_log', False):
        global cloudPerfH2O
        cloudPerfH2O = h2o_perf.PerfH2O(python_test_name)
    ports_per_node = 2
    node_list = []
    try:
        totalNodes = 0
        portList = [(base_port + (ports_per_node * i)) for i in range(node_count)]
        if (hosts is None):
            write_flatfile(node_count=node_count, base_port=base_port)
            hostCount = 1
            if rand_shuffle:
                random.shuffle(portList)
            for p in portList:
                verboseprint('psutil starting node', i)
                newNode = LocalH2O(port=p, node_id=totalNodes, **kwargs)
                node_list.append(newNode)
                totalNodes += 1
        else:
            hostCount = len(hosts)
            hostPortList = []
            for h in hosts:
                for port in portList:
                    hostPortList.append((h, port))
            if rand_shuffle:
                random.shuffle(hostPortList)
            for (h, p) in hostPortList:
                if hadoop:
                    newNode = h.hadoop_h2o(port=p, node_id=totalNodes, **kwargs)
                else:
                    verboseprint('ssh starting node', totalNodes, 'via', h)
                    newNode = h.remote_h2o(port=p, node_id=totalNodes, **kwargs)
                node_list.append(newNode)
                totalNodes += 1
        verboseprint('Attempting Cloud stabilize of', totalNodes, 'nodes on', hostCount, 'hosts')
        start = time.time()
        stabilize_cloud(node_list[(-1)], len(node_list), timeoutSecs=timeoutSecs, retryDelaySecs=retryDelaySecs)
        verboseprint(len(node_list), 'Last added node stabilized in ', (time.time() - start), ' secs')
        verboseprint(('Built cloud: %d nodes on %d hosts, in %d s' % (len(node_list), hostCount, (time.time() - start))))
        for n in node_list:
            stabilize_cloud(n, len(node_list), timeoutSecs=timeoutSecs)
        check_sandbox_for_errors()
    except:
        if cleanup:
            for n in node_list:
                n.terminate()
        else:
            nodes[:] = node_list
        check_sandbox_for_errors()
        raise
    nodes[:] = node_list
    print len(node_list), 'total jvms in H2O cloud'
    return node_list
